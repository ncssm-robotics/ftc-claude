name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'
  pull_request:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin structure
        run: |
          echo "üîç Validating plugin structure..."

          errors=0

          # Check each plugin directory
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "üì¶ Checking plugin: $plugin_name"

            # Check plugin.json exists
            if [ ! -f "$plugin_dir/plugin.json" ]; then
              echo "‚ùå Missing plugin.json in $plugin_name"
              errors=$((errors + 1))
            else
              echo "  ‚úì plugin.json exists"

              # Validate plugin.json is valid JSON
              if ! jq empty "$plugin_dir/plugin.json" 2>/dev/null; then
                echo "‚ùå Invalid JSON in $plugin_dir/plugin.json"
                errors=$((errors + 1))
              else
                echo "  ‚úì plugin.json is valid JSON"
              fi
            fi

            # Check skills directory exists
            if [ ! -d "$plugin_dir/skills" ]; then
              echo "‚ùå Missing skills/ directory in $plugin_name"
              errors=$((errors + 1))
            else
              echo "  ‚úì skills/ directory exists"
            fi

            # Check SKILL.md exists for each skill
            for skill_dir in "$plugin_dir/skills/"*/; do
              if [ -d "$skill_dir" ]; then
                skill_name=$(basename "$skill_dir")
                if [ ! -f "$skill_dir/SKILL.md" ]; then
                  echo "‚ùå Missing SKILL.md in $skill_name"
                  errors=$((errors + 1))
                else
                  echo "  ‚úì $skill_name/SKILL.md exists"

                  # Validate SKILL.md has required frontmatter
                  if ! head -1 "$skill_dir/SKILL.md" | grep -q "^---$"; then
                    echo "‚ùå SKILL.md missing YAML frontmatter in $skill_name"
                    errors=$((errors + 1))
                  else
                    # Check for required fields
                    if ! grep -q "^name:" "$skill_dir/SKILL.md"; then
                      echo "‚ùå SKILL.md missing 'name' field in $skill_name"
                      errors=$((errors + 1))
                    fi
                    if ! grep -q "^description:" "$skill_dir/SKILL.md"; then
                      echo "‚ùå SKILL.md missing 'description' field in $skill_name"
                      errors=$((errors + 1))
                    fi
                  fi
                fi
              fi
            done

            echo ""
          done

          # Check marketplace.json
          echo "üìã Checking marketplace.json..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "‚ùå Missing .claude-plugin/marketplace.json"
            errors=$((errors + 1))
          else
            if ! jq empty ".claude-plugin/marketplace.json" 2>/dev/null; then
              echo "‚ùå Invalid JSON in marketplace.json"
              errors=$((errors + 1))
            else
              echo "‚úì marketplace.json is valid"
            fi
          fi

          echo ""
          if [ $errors -gt 0 ]; then
            echo "‚ùå Validation failed with $errors error(s)"
            exit 1
          else
            echo "‚úÖ All validations passed!"
          fi

      - name: Check skill name consistency
        run: |
          echo "üîç Checking skill name consistency..."

          errors=0

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")

            for skill_dir in "$plugin_dir/skills/"*/; do
              if [ -d "$skill_dir" ]; then
                folder_name=$(basename "$skill_dir")

                # Extract name from SKILL.md frontmatter (only first block)
                if [ -f "$skill_dir/SKILL.md" ]; then
                  yaml_name=$(awk 'NR==1 && /^---$/{found=1; next} found && /^---$/{exit} found && /^name:/{gsub(/^name: */, ""); print; exit}' "$skill_dir/SKILL.md")

                  if [ "$folder_name" != "$yaml_name" ]; then
                    echo "‚ùå Name mismatch in $plugin_name: folder='$folder_name' vs SKILL.md name='$yaml_name'"
                    errors=$((errors + 1))
                  else
                    echo "‚úì $plugin_name/$folder_name name is consistent"
                  fi
                fi
              fi
            done
          done

          if [ $errors -gt 0 ]; then
            echo "‚ùå Name consistency check failed"
            exit 1
          else
            echo "‚úÖ All skill names are consistent!"
          fi
