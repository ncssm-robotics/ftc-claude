name: Validate Skills

on:
  push:
    branches: [main, develop]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'plugins/**'
      - '.claude-plugin/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin structure
        run: |
          echo "üîç Validating plugin structure..."

          errors=0

          # Check each plugin directory
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "üì¶ Checking plugin: $plugin_name"

            # Check plugin.json exists
            if [ ! -f "$plugin_dir/plugin.json" ]; then
              echo "‚ùå Missing plugin.json in $plugin_name"
              errors=$((errors + 1))
            else
              echo "  ‚úì plugin.json exists"

              # Validate plugin.json is valid JSON
              if ! jq empty "$plugin_dir/plugin.json" 2>/dev/null; then
                echo "‚ùå Invalid JSON in $plugin_dir/plugin.json"
                errors=$((errors + 1))
              else
                echo "  ‚úì plugin.json is valid JSON"
              fi
            fi

            # Check skills directory exists
            if [ ! -d "$plugin_dir/skills" ]; then
              echo "‚ùå Missing skills/ directory in $plugin_name"
              errors=$((errors + 1))
            else
              echo "  ‚úì skills/ directory exists"
            fi

            # Check SKILL.md exists for each skill
            for skill_dir in "$plugin_dir/skills/"*/; do
              if [ -d "$skill_dir" ]; then
                skill_name=$(basename "$skill_dir")
                if [ ! -f "$skill_dir/SKILL.md" ]; then
                  echo "‚ùå Missing SKILL.md in $skill_name"
                  errors=$((errors + 1))
                else
                  echo "  ‚úì $skill_name/SKILL.md exists"

                  # Validate SKILL.md has required frontmatter
                  if ! head -1 "$skill_dir/SKILL.md" | grep -q "^---$"; then
                    echo "‚ùå SKILL.md missing YAML frontmatter in $skill_name"
                    errors=$((errors + 1))
                  else
                    # Check for required fields
                    if ! grep -q "^name:" "$skill_dir/SKILL.md"; then
                      echo "‚ùå SKILL.md missing 'name' field in $skill_name"
                      errors=$((errors + 1))
                    fi
                    if ! grep -q "^description:" "$skill_dir/SKILL.md"; then
                      echo "‚ùå SKILL.md missing 'description' field in $skill_name"
                      errors=$((errors + 1))
                    fi
                  fi
                fi
              fi
            done

            echo ""
          done

          # Check marketplace.json
          echo "üìã Checking marketplace.json..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "‚ùå Missing .claude-plugin/marketplace.json"
            errors=$((errors + 1))
          else
            if ! jq empty ".claude-plugin/marketplace.json" 2>/dev/null; then
              echo "‚ùå Invalid JSON in marketplace.json"
              errors=$((errors + 1))
            else
              echo "‚úì marketplace.json is valid"
            fi
          fi

          echo ""
          if [ $errors -gt 0 ]; then
            echo "‚ùå Validation failed with $errors error(s)"
            exit 1
          else
            echo "‚úÖ All validations passed!"
          fi

      - name: Check skill name consistency
        run: |
          echo "üîç Checking skill name consistency..."

          errors=0

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")

            for skill_dir in "$plugin_dir/skills/"*/; do
              if [ -d "$skill_dir" ]; then
                folder_name=$(basename "$skill_dir")

                # Extract name from SKILL.md frontmatter (only first block)
                if [ -f "$skill_dir/SKILL.md" ]; then
                  yaml_name=$(awk 'NR==1 && /^---$/{found=1; next} found && /^---$/{exit} found && /^name:/{gsub(/^name: */, ""); print; exit}' "$skill_dir/SKILL.md")

                  if [ "$folder_name" != "$yaml_name" ]; then
                    echo "‚ùå Name mismatch in $plugin_name: folder='$folder_name' vs SKILL.md name='$yaml_name'"
                    errors=$((errors + 1))
                  else
                    echo "‚úì $plugin_name/$folder_name name is consistent"
                  fi
                fi
              fi
            done
          done

          if [ $errors -gt 0 ]; then
            echo "‚ùå Name consistency check failed"
            exit 1
          else
            echo "‚úÖ All skill names are consistent!"
          fi

      - name: Validate version format and consistency
        run: |
          echo "üî¢ Validating plugin versions..."

          errors=0
          warnings=0

          # Semantic version regex (X.Y.Z with optional prerelease)
          semver_regex='^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$'

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "üì¶ Checking version for: $plugin_name"

            # Get version from plugin.json
            if [ -f "$plugin_dir/plugin.json" ]; then
              plugin_version=$(jq -r '.version // empty' "$plugin_dir/plugin.json")

              if [ -z "$plugin_version" ]; then
                echo "‚ùå Missing version field in $plugin_name/plugin.json"
                errors=$((errors + 1))
              elif ! echo "$plugin_version" | grep -qE "$semver_regex"; then
                echo "‚ùå Invalid version format '$plugin_version' in $plugin_name (expected X.Y.Z)"
                errors=$((errors + 1))
              else
                echo "  ‚úì plugin.json version: $plugin_version"
              fi

              # Check version in SKILL.md metadata
              for skill_dir in "$plugin_dir/skills/"*/; do
                if [ -d "$skill_dir" ] && [ -f "$skill_dir/SKILL.md" ]; then
                  skill_name=$(basename "$skill_dir")

                  # Extract version from SKILL.md frontmatter metadata block
                  skill_version=$(awk '
                    BEGIN { in_frontmatter=0; in_metadata=0 }
                    /^---$/ {
                      if (in_frontmatter) exit
                      in_frontmatter=1
                      next
                    }
                    in_frontmatter && /^metadata:/ { in_metadata=1; next }
                    in_frontmatter && in_metadata && /^  version:/ {
                      gsub(/^  version: *["'\'']?/, "")
                      gsub(/["'\'']$/, "")
                      print
                      exit
                    }
                    in_frontmatter && /^[a-z]/ && !/^  / { in_metadata=0 }
                  ' "$skill_dir/SKILL.md")

                  if [ -n "$skill_version" ]; then
                    if [ "$plugin_version" != "$skill_version" ]; then
                      # Warning only - release script handles version consistency
                      # New skills start at 1.0.0, versions are bumped atomically during release
                      echo "  ‚ö† Version differs: plugin.json='$plugin_version' vs SKILL.md='$skill_version' (release script will sync)"
                      warnings=$((warnings + 1))
                    else
                      echo "  ‚úì SKILL.md version matches: $skill_version"
                    fi
                  else
                    echo "  ‚ö† No version in SKILL.md metadata for $skill_name (recommended)"
                    warnings=$((warnings + 1))
                  fi
                fi
              done

              # Check version in marketplace.json
              marketplace_version=$(jq -r --arg name "$plugin_name" '.plugins[] | select(.name == $name) | .version // empty' .claude-plugin/marketplace.json)

              if [ -z "$marketplace_version" ]; then
                echo "  ‚ö† No version in marketplace.json for $plugin_name (recommended)"
                warnings=$((warnings + 1))
              elif [ "$plugin_version" != "$marketplace_version" ]; then
                echo "‚ùå Version mismatch: plugin.json='$plugin_version' vs marketplace.json='$marketplace_version'"
                errors=$((errors + 1))
              else
                echo "  ‚úì marketplace.json version matches: $marketplace_version"
              fi
            fi

            echo ""
          done

          echo ""
          if [ $warnings -gt 0 ]; then
            echo "‚ö† $warnings warning(s) - consider adding missing version fields"
          fi

          if [ $errors -gt 0 ]; then
            echo "‚ùå Version validation failed with $errors error(s)"
            exit 1
          else
            echo "‚úÖ All version validations passed!"
          fi
